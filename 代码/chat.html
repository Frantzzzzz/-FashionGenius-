<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­æ­-ä½ çš„ä¸“å±AIç©¿æ­åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="chat_styles.css">
</head>
<body>
    <!-- å¤´åƒè£å‰ªæ¨¡æ€æ¡† -->
    <div class="modal" id="cropModal">
        <div class="modal-content">
            <div id="cropper-container" style="width: 100%; height: 400px;">
                <img id="cropper-image" style="max-width: 100%; max-height: 100%;">
            </div>
            <div class="modal-actions">
                <button onclick="cancelCrop()" style="background: #e2e8f0; color: #4a5568;">å–æ¶ˆ</button>
                <button onclick="applyCrop()">ç¡®è®¤è£å‰ª</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢ä¸€ï¼šç™»å½•ç•Œé¢ -->
    <div class="container page active" id="page1">
        <div class="decoration decoration-1"></div>
        <div class="decoration decoration-2"></div>
        <div class="content-wrapper">
            <h2>æ¬¢è¿æ¥åˆ°æ­æ­ï¼ä½ çš„AIç©¿æ­åŠ©æ‰‹ ğŸ‘—</h2>
            <p style="color: #4a5568; margin-bottom: 2rem;">è®©æˆ‘ä»¬å¼€å§‹æ‰“é€ æ‚¨çš„ä¸“å±ç©¿æ­é£æ ¼å§~</p>
            
            <div class="form-group avatar-upload">
                <div class="avatar-options" id="avatar-options">
                    <div class="avatar-option selected" style="background-image: url('http://img2.baidu.com/it/u=1010222189,1658135931&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="1"></div>
                    <div class="avatar-option" style="background-image: url('http://img2.baidu.com/it/u=4073157017,1496656754&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="2"></div>
                    <div class="avatar-option" style="background-image: url('http://img0.baidu.com/it/u=192249648,1398446147&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="3"></div>
                    <div class="avatar-option" style="background-image: url('http://img0.baidu.com/it/u=2935836209,2029867742&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="4"></div>
                    <div class="avatar-option" style="background-image: url('http://img2.baidu.com/it/u=3218732801,102703520&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="5"></div>
                    <div class="avatar-option" style="background-image: url('http://img1.baidu.com/it/u=3764858993,3084695764&fm=253&app=138&f=JPEG?w=500&h=500')" data-avatar="6"></div>
                </div>
                <div class="avatar-preview" id="avatar-preview" style="background-image: url('https://api.dicebear.com/7.x/adventurer/svg?seed=1')"></div>
                <label for="avatar">æˆ–ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ</label>
                <input type="file" id="avatar" accept="image/*">
            </div>
            
            <div class="form-group">
                <label>æ˜µç§°</label>
                <div class="username-input-container">
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°">
                    <button class="random-username-btn" onclick="generateRandomUsername()" title="éšæœºç”Ÿæˆæ˜µç§°">
                        <i class="fas fa-dice"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ€§åˆ«</label>
                <select id="user_sex">
                    <option value="å¥³">å¥³</option>
                    <option value="ç”·">ç”·</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>å¹´é¾„(å²)</label>
                <input type="number" id="age" min="10" max="100" placeholder="ä¾‹å¦‚ï¼š20">
            </div>
            
            <div class="nav-buttons">
                <div></div> <!-- å ä½ç©ºdiv -->
                <button onclick="validatePage1()">å¼€å§‹ç©¿æ­ä¹‹æ—… â†’</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢äºŒï¼šåŸºæœ¬ä¿¡æ¯ -->
    <div class="container page" id="page2">
        <div class="content-wrapper">
            <h2>æ‚¨çš„èº«ä½“æ•°æ® ğŸ“</h2>
            <p style="color: #4a5568; margin-bottom: 2rem;">æä¾›å‡†ç¡®çš„èº«ä½“æ•°æ®æœ‰åŠ©äºæˆ‘ä»¬ç»™å‡ºæ›´åˆé€‚çš„å»ºè®®</p>
            
            <div class="form-group">
                <label>èº«é«˜(cm)</label>
                <input type="number" id="height" min="100" max="250" placeholder="ä¾‹å¦‚ï¼š165">
            </div>
            
            <div class="form-group">
                <label>ä½“é‡(kg)</label>
                <input type="number" id="weight" min="30" max="200" placeholder="ä¾‹å¦‚ï¼š50">
            </div>
            
            <div class="form-group">
                <label>ä½“å‹</label>
                <div>
                    <div class="option-btn" data-body-type="pear">æ¢¨å‹</div>
                    <div class="option-btn" data-body-type="apple">è‹¹æœå‹</div>
                    <div class="option-btn" data-body-type="hourglass">æ²™æ¼å‹</div>
                    <div class="option-btn" data-body-type="rectangle">ç›´ç­’å‹</div>
                    <div class="option-btn" data-body-type="inverted-triangle">å€’ä¸‰è§’å‹</div>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button onclick="prevPage()" style="background: #e2e8f0; color: #4a5568;">â† è¿”å›</button>
                <button onclick="validatePage2()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢ä¸‰ï¼šé£æ ¼åå¥½ -->
    <div class="container page" id="page3">
        <div class="content-wrapper">
            <h2>æ‚¨çš„é£æ ¼åå¥½ ğŸ¨</h2>
            <p style="color: #4a5568; margin-bottom: 2rem;">é€‰æ‹©æ‚¨å–œæ¬¢çš„é¢œè‰²å’Œé£æ ¼ï¼Œè®©æˆ‘ä»¬æ›´äº†è§£æ‚¨çš„å“å‘³</p>
            
            <div class="form-group">
                <label>æ‚¨å–œæ¬¢ä»€ä¹ˆé¢œè‰²å‘¢ï¼Ÿ</label>
                <div class="color-picker">
                    <div class="color-option" style="background:#1C64F2" data-color="blue" title="è“è‰²"></div>
                    <div class="color-option" style="background:#ef2525" data-color="red" title="çº¢è‰²"></div>
                    <div class="color-option" style="background:#28b02c" data-color="green" title="ç»¿è‰²"></div>
                    <div class="color-option" style="background:#b720d2" data-color="purple" title="ç´«è‰²"></div>
                    <div class="color-option" style="background:#ff7700" data-color="orange" title="æ©™è‰²"></div>
                    <div class="color-option" style="background:#bababa" data-color="gray" title="ç°è‰²"></div>
                    <div class="color-option" style="background:#000000" data-color="black" title="é»‘è‰²"></div>
                    <div class="color-option" style="background:#FFFFFF;border:1px solid #eee" data-color="white" title="ç™½è‰²"></div>
                    <div class="color-option" style="background:#ffcd03" data-color="yellow" title="é»„è‰²"></div>
                    <div class="color-option" style="background:#ff96b9" data-color="pink" title="ç²‰è‰²"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ‚¨åå¥½çš„é£æ ¼æ˜¯ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div>
                    <div class="option-btn" data-style="chinese">ä¸­å›½é£</div>
                    <div class="option-btn" data-style="commute">é€šå‹¤é£</div>
                    <div class="option-btn" data-style="new-chinese">æ–°ä¸­å¼</div>
                    <div class="option-btn" data-style="byzantine">æ‹œå åº­è‰ºæœ¯</div>
                    <div class="option-btn" data-style="dopamine">å¤šå·´èƒºç©¿æ­</div>
                    <div class="option-btn" data-style="japanese">æ—¥ç³»</div>
                    <div class="option-btn" data-style="casual">ä¼‘é—²é£</div>
                    <div class="option-btn" data-style="lady">æ·‘å¥³é£</div>
                    <div class="option-btn" data-style="romantic">æµªæ¼«ä¸»ä¹‰</div>
                    <div class="option-btn" data-style="mallard">ç¾æ‹‰å¾·ç©¿æ­</div>
                    <div class="option-btn" data-style="korean">éŸ©ç³»</div>
                    <div class="option-btn" data-style="country">ç”°å›­é£</div>
                    <div class="option-btn" data-style="socialite">ååª›é£</div>
                    <div class="option-btn" data-style="gothic">å“¥ç‰¹é£æ ¼</div>
                    <div class="option-btn" data-style="european">æ¬§ç¾é£</div>
                    <div class="option-btn" data-style="campus">æ ¡å›­é£</div>
                    <div class="option-btn" data-style="rayli">ç‘ä¸½é£</div>
                    <div class="option-btn" data-style="baroque">å·´æ´›å…‹é£æ ¼</div>
                    <div class="option-btn" data-style="british">è‹±ä¼¦é£</div>
                    <div class="option-btn" data-style="sporty">è¿åŠ¨é£</div>
                    <div class="option-btn" data-style="simple">ç®€çº¦é£</div>
                    <div class="option-btn" data-style="rococo">æ´›å¯å¯é£æ ¼</div>
                    <div class="option-btn" data-style="french">æ³•å¼</div>
                    <div class="option-btn" data-style="party">Partyé£</div>
                    <div class="option-btn" data-style="minimal">æç®€é£</div>
                    <div class="option-btn" data-style="lolita">æ´›ä¸½å¡”é£æ ¼</div>
                    <div class="option-btn" data-style="bohemian">æ³¢è¥¿ç±³äºš</div>
                    <div class="option-btn" data-style="date">çº¦ä¼šè£…</div>
                    <div class="option-btn" data-style="neutral">ä¸­æ€§é£</div>
                    <div class="option-btn" data-style="victorian">ç»´å¤šåˆ©äºšé£</div>
                    <div class="option-btn" data-style="vacation">åº¦å‡é£</div>
                    <div class="option-btn" data-style="normcore">æ€§å†·æ·¡</div>
                    <div class="option-btn" data-style="neoclassical">æ–°å¤å…¸ä¸»ä¹‰</div>
                    <div class="option-btn" data-style="ethnic">æ°‘æ—é£</div>
                    <div class="option-btn" data-style="new-raphaelite">æ–°æ‹‰æ–å°”æ´¾</div>
                    <div class="option-btn" data-style="dramatic">æˆå‰§é£</div>
                    <div class="option-btn" data-style="soviet">è‹è”é£æ ¼</div>
                    <div class="option-btn" data-style="retro">å¤å¤é£</div>
                    <div class="option-btn" data-style="surrealism">è¶…ç°å®ä¸»ä¹‰</div>
                    <div class="option-btn" data-style="y2k">Y2K</div>
                    <div class="option-btn" data-style="pop">æ³¢æ™®è‰ºæœ¯</div>
                    <div class="option-btn" data-style="hiphop">å˜»å“ˆé£</div>
                    <div class="option-btn" data-style="op">æ¬§æ™®è‰ºæœ¯</div>
                    <div class="option-btn" data-style="punk">æœ‹å…‹é£</div>
                    <div class="option-btn" data-style="minimalism">æç®€ä¸»ä¹‰</div>
                    <div class="option-btn" data-style="hippie">å¬‰çš®é£</div>
                    <div class="option-btn" data-style="futurism">æœªæ¥ä¸»ä¹‰</div>
                    <div class="option-btn" data-style="sweet-cool">ç”œé…·é£</div>
                </div>
            </div>

            <div class="form-group">
                <label>é€‚é…å­£èŠ‚ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="season-options">
                    <div class="season-option" data-season="spring">æ˜¥</div>
                    <div class="season-option" data-season="summer">å¤</div>
                    <div class="season-option" data-season="autumn">ç§‹</div>
                    <div class="season-option" data-season="winter">å†¬</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ‚¨çš„å…·ä½“éœ€æ±‚ï¼ˆå¯ä¸å¡«å†™ï¼‰</label>
                <input type="text" id="query" placeholder="ä¾‹å¦‚ï¼šå°ä¸ªå­æ˜¾é«˜æ”»ç•¥ã€ä¸Šç­é€šå‹¤ç©¿æ­ã€çº¦ä¼šç©¿æ­å»ºè®®ç­‰">
            </div>
            
            <div class="nav-buttons">
                <button onclick="prevPage()" style="background: #e2e8f0; color: #4a5568;">â† è¿”å›</button>
                <button onclick="generateRecommendation()">ç”Ÿæˆæ¨è â†’</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢å››ï¼šæ¨èç»“æœ -->
    <div class="container page" id="page4">
        <div class="content-wrapper">
            <h2>æ‚¨çš„ä¸“å±ç©¿æ­å»ºè®® âœ¨</h2>
            <!-- <div class="success-message">
                å·²æ ¹æ®æ‚¨çš„ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–ç©¿æ­å»ºè®®ï¼Œè¯·æŸ¥æ”¶~
            </div> -->
            <div id="recommendation-text"></div>
            
            <div class="chat-tip">
                <p>ğŸ’¡ è¿˜æƒ³äº†è§£æ›´å¤šï¼Ÿç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸æ­æ­ç›´æ¥å¯¹è¯ï¼Œè·å–æ›´å¤šä¸ªæ€§åŒ–å»ºè®®ï¼</p>
            </div>
            
            <div class="nav-buttons">
                <button onclick="prevPage()" style="background: #e2e8f0; color: #4a5568;">â† è¿”å›</button>
                <button onclick="nextPage(5)">ä¸æ­æ­å¯¹è¯ ğŸ’¬</button>
            </div>
        </div>
    </div>
    
    <!-- é¡µé¢äº”ï¼šèŠå¤©æœºå™¨äººé¡µé¢ -->
    <div class="container page" id="page5">
        <div class="content-wrapper">
            <h2>ä¸æ­æ­å¯¹è¯ ğŸ’¬</h2>
            <p style="color: #4a5568; margin-bottom: 1rem;">æ‚¨å¯ä»¥ç»§ç»­è¯¢é—®æ›´å¤šç©¿æ­å»ºè®®ï¼Œæˆ‘ä¼šæ ¹æ®æ‚¨ä¹‹å‰æä¾›çš„ä¿¡æ¯ä¸ºæ‚¨æœåŠ¡~</p>
            
            <div class="chat-container" id="dify-chatbot-container">
                <iframe
                    id="chatbot-iframe"
                    style="width: 100%; height: 100%; border: none; border-radius: 12px;"
                    frameborder="0"
                    allow="microphone">
                </iframe>
            </div>
            
            <div class="nav-buttons">
                <button onclick="prevPage()" style="background: #e2e8f0; color: #4a5568;">â† è¿”å›</button>
                <button onclick="nextPage(1)">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <script>
        // é¡µé¢å¯¼èˆªæ§åˆ¶
        let currentPage = 1;
        let cropper;
        let userData = {}; // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œç”¨äºèŠå¤©æœºå™¨äºº
        
        function nextPage(pageNum) {
            document.querySelector(`#page${currentPage}`).classList.remove('active');
            currentPage = pageNum;
            document.querySelector(`#page${currentPage}`).classList.add('active');
            
            // å¦‚æœæ˜¯èŠå¤©é¡µé¢ï¼Œåˆå§‹åŒ–èŠå¤©iframe
            if (pageNum === 5) {
                initDifyChatbot();
            }
        }

        function prevPage() {
            nextPage(currentPage - 1);
        }

        // å¤´åƒä¸Šä¼ å’Œè£å‰ª
        document.getElementById('avatar').addEventListener('change', function(e) {
            if (e.target.files.length === 0) return;
            
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                document.getElementById('cropper-image').src = event.target.result;
                document.getElementById('cropModal').style.display = 'flex';
                
                // åˆå§‹åŒ–Cropper
                const image = document.getElementById('cropper-image');
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    guides: false
                });
            };
            
            reader.readAsDataURL(file);
        });

        function cancelCrop() {
            document.getElementById('cropModal').style.display = 'none';
            document.getElementById('avatar').value = '';
        }

        function applyCrop() {
            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 300,
                minWidth: 256,
                minHeight: 256,
                maxWidth: 4096,
                maxHeight: 4096,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            
            document.getElementById('avatar-preview').style.backgroundImage = `url(${canvas.toDataURL()})`;
            document.getElementById('cropModal').style.display = 'none';
            
            // å–æ¶ˆé€‰æ‹©ä»»ä½•å›ºå®šå¤´åƒ
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        // é€‰é¡¹é€‰æ‹©äº¤äº’
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // å¦‚æœæ˜¯ä½“å‹é€‰æ‹©ï¼Œåªèƒ½å•é€‰
                if (this.dataset.bodyType) {
                    document.querySelectorAll('[data-body-type]').forEach(b => b.classList.remove('selected'));
                }
                this.classList.toggle('selected');
            });
        });

        // é¢œè‰²é€‰æ‹©äº¤äº’
        document.querySelectorAll('.color-option').forEach(color => {
            color.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });

        // å›ºå®šå¤´åƒé€‰æ‹©
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const avatarUrl = this.style.backgroundImage;
                document.getElementById('avatar-preview').style.backgroundImage = avatarUrl;
                document.getElementById('avatar').value = ''; // æ¸…é™¤ä¸Šä¼ çš„å¤´åƒ
            });
        });

        // éšæœºæ˜µç§°ç”Ÿæˆ
        function generateRandomUsername() {
            const adjectives = [
                'ä¼˜é›…', 'çµåŠ¨', 'è¿·äºº', 'è‡ªä¿¡', 'è€€çœ¼', 'æ¸…æ–°', 
                'æ—¶å°š', 'ç²¾è‡´', 'å…¸é›…', 'æµªæ¼«', 'é«˜è´µ', 'ç‡çœŸ',
                'å¤§æ–¹', 'æ´»æ³¼', 'æ´»åŠ›', 'æ½®æµ', 'å‹‡æ•¢', 'è½»ç›ˆ'
            ];
            const nouns = [
                'å®‰å¦®', 'å®‰å¨œ', 'ç±³å¨…', 'è¯ºäºš', 'è‰¾è‰', 'æ±¤å§†',
                'æ°è¥¿', 'èŒèŒ', 'å°é¹¿', 'å½©è™¹', 'éœ²è¥¿', 'çš®çš®',
                'äº‘æœµ', 'æ˜Ÿè¾°', 'å¾®é£', 'é˜³å…‰', 'èŠ±è¯­', 'æµ·æ´‹'
            ];
            const suffixes = [
                'å°å§', 'å…ˆç”Ÿ', '', '', '', ''  // ç©ºå­—ç¬¦ä¸²å¢åŠ ä¸ä½¿ç”¨åç¼€çš„æ¦‚ç‡
            ];
            
            // éšæœºé€‰æ‹©ç»„åˆ
            const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            // ç”Ÿæˆéšæœºæ•° (0-99)ï¼Œä½†åªæœ‰20%æ¦‚ç‡æ·»åŠ æ•°å­—
            let nameWithNumber = '';
            if (Math.random() < 0.2) {
                const randomNum = Math.floor(Math.random() * 100);
                nameWithNumber = randomNum.toString();
            }
            
            // ç»„åˆæˆæ˜µç§° (æ ¹æ®æ˜¯å¦æœ‰åç¼€å’Œæ•°å­—æ¥è°ƒæ•´æ ¼å¼)
            let username;
            if (randomSuffix) {
                username = `${randomAdj}çš„${randomNoun}${randomSuffix}${nameWithNumber}`;
            } else {
                username = `${randomAdj}çš„${randomNoun}${nameWithNumber}`;
            }
            
            document.getElementById('username').value = username;
        }

        // é¡µé¢ä¸€éªŒè¯
        function validatePage1() {
            const username = document.getElementById('username').value.trim();
            const age = document.getElementById('age').value;
            
            if (!username) {
                alert('ç»™è‡ªå·±èµ·ä¸ªå¯çˆ±/å¸…æ°”çš„æ˜µç§°å§ï¼è¿™æ ·æ­æ­æ‰èƒ½æ›´å¥½åœ°è®¤è¯†ä½ å‘€~');
                return;
            }
            
            if (!age) {
                alert('è¯·å¡«å†™çœŸå®å¹´é¾„å“¦~ è¿™æ ·æ­æ­æ‰èƒ½æ¨èé€‚åˆä½ å¹´é¾„æ®µçš„ç©¿æ­å‘¢ï¼');
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·æ•°æ®
            userData = {
                username: username,
                user_sex: document.getElementById('user_sex').value,
                age: age,
                avatar: document.getElementById('avatar-preview').style.backgroundImage
            };
            
            nextPage(2);
        }

        function validatePage2() {
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const bodyType = document.querySelector('[data-body-type].selected');
            
            if (!height) {
                alert('è¯·å¡«å†™çœŸå®èº«é«˜å“¦~ è¿™æ ·æ­æ­æ‰èƒ½æ¨èåˆèº«çš„è¡£æœå‘¢ï¼');
                return;
            }
            
            if (!weight) {
                alert('è¯·å¡«å†™çœŸå®ä½“é‡å“¦~ æ”¾å¿ƒï¼Œè¿™æ˜¯æˆ‘ä»¬çš„ç§˜å¯†ï¼Œæ­æ­ä¸ä¼šå‘Šè¯‰åˆ«äººçš„~');
                return;
            }
            
            if (!bodyType) {
                alert('è¯·é€‰æ‹©æ‚¨çš„ä½“å‹~ è¿™æ ·æ­æ­æ‰èƒ½æ‰¬é•¿é¿çŸ­ï¼Œæ¨èæœ€é€‚åˆæ‚¨çš„ç©¿æ­æ–¹æ¡ˆï¼');
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·æ•°æ®
            userData.height = height;
            userData.weight = weight;
            userData.body_shape = bodyType.dataset.bodyType;
            
            nextPage(3);
        }
        // ç”Ÿæˆæ¨è
        async function generateRecommendation() {
            // å­£èŠ‚æ˜ å°„è¡¨ï¼ˆè‹±æ–‡è½¬ä¸­æ–‡ï¼‰
            const selectedSeasons = [...document.querySelectorAll('.season-option.selected')]
                .map(season => {
                    const seasonMap = {
                        "spring": "æ˜¥",
                        "summer": "å¤",
                        "autumn": "ç§‹",
                        "winter": "å†¬"
                    };
                    return seasonMap[season.dataset.season] || season.dataset.season;
                });

            // å¦‚æœæ²¡æœ‰é€‰æ‹©å­£èŠ‚ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰å­£èŠ‚
            if (selectedSeasons.length === 0) {
                const currentMonth = new Date().getMonth() + 1;
                let defaultSeason = "æ˜¥";
                if (currentMonth >= 3 && currentMonth <= 5) defaultSeason = "æ˜¥";
                else if (currentMonth >= 6 && currentMonth <= 8) defaultSeason = "å¤";
                else if (currentMonth >= 9 && currentMonth <= 11) defaultSeason = "ç§‹";
                else defaultSeason = "å†¬";
                selectedSeasons.push(defaultSeason);
            }

            // ä½“å‹æ˜ å°„è¡¨ï¼ˆè‹±æ–‡è½¬ä¸­æ–‡ï¼‰
            const bodyShapeMap = {
                "pear": "æ¢¨å‹",
                "apple": "è‹¹æœå‹",
                "hourglass": "æ²™æ¼å‹",
                "rectangle": "ç›´ç­’å‹",
                "inverted-triangle": "å€’ä¸‰è§’å‹"
            };

            // æ”¶é›†ç”¨æˆ·æ•°æ®ï¼ˆå…¨éƒ¨è½¬ä¸ºä¸­æ–‡ï¼‰
            userData = {
                username: document.getElementById('username').value,
                user_sex: document.getElementById('user_sex').value, // å·²ç»æ˜¯ä¸­æ–‡
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                body_shape: bodyShapeMap[document.querySelector('[data-body-type].selected')?.dataset.bodyType] || "",
                colors: [...document.querySelectorAll('.color-option.selected')].map(c => {
                    const colorMap = {
                        "blue": "è“è‰²",
                        "red": "çº¢è‰²",
                        "green": "ç»¿è‰²",
                        "purple": "ç´«è‰²",
                        "orange": "æ©™è‰²",
                        "gray": "ç°è‰²",
                        "black": "é»‘è‰²",
                        "white": "ç™½è‰²",
                        "yellow": "é»„è‰²",
                        "pink": "ç²‰è‰²"
                    };
                    return colorMap[c.dataset.color] || c.dataset.color;
                }),
                style: [...document.querySelectorAll('[data-style].selected')]
                    .map(el => el.textContent.trim()), // ç›´æ¥å–ä¸­æ–‡æ–‡æœ¬ï¼ˆå¦‚"ä¸­å›½é£"ï¼‰
                season: selectedSeasons,
                query: document.getElementById('query').value || "è¯·æ ¹æ®æˆ‘çš„ä¿¡æ¯æ¨èåˆé€‚çš„ç©¿æ­"
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('recommendation-text').innerHTML = `
                <p style="text-align: center;">æ­£åœ¨æ ¹æ®æ‚¨çš„ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–ç©¿æ­å»ºè®®...</p>
                <div class="loading-spinner"></div>
            `;

            nextPage(4);

            try {
                // å‡†å¤‡APIè¯·æ±‚æ•°æ®ï¼ˆå…¨éƒ¨ä¸­æ–‡ï¼‰
                const apiData = {
                    inputs: {
                        user_sex: userData.user_sex,
                        age: String(userData.age),
                        height: String(userData.height),
                        weight: String(userData.weight),
                        season: userData.season.join('ï¼Œ'),
                        body_shape: userData.body_shape,
                        style: userData.style.join('ï¼Œ'), 
                        colors: userData.colors.join('ï¼Œ')
                    },
                    query: userData.query,
                    response_mode: "blocking",
                    conversation_id: "",
                    user: "abc-123"  
                };

                console.log("APIè¯·æ±‚æ•°æ®ï¼ˆä¸­æ–‡ï¼‰:", JSON.stringify(apiData, null, 2));

                const response = await fetch('http://localhost/v1/chat-messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer app-78GXf0JFVCjfl155l4apaGCV',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(apiData)
                });

                if (!response.ok) {
                    const errorResponse = await response.json().catch(() => ({}));
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} - ${errorResponse.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const result = await response.json();
                document.getElementById('recommendation-text').innerHTML = result.answer || "æœªè·å–åˆ°æœ‰æ•ˆå»ºè®®";

            } catch (error) {
                document.getElementById('recommendation-text').innerHTML = `
                    <p style="color: red">ç”Ÿæˆæ¨èæ—¶å‡ºé”™:</p>
                    <p><strong>${error.message}</strong></p>
                    <button onclick="generateRecommendation()" style="margin-top: 10px;">é‡è¯•</button>
                `;
            }
        }

        function initDifyChatbot() {
            try {
                // æ„å»ºURLå‚æ•°
                const params = new URLSearchParams();
                
                // æ·»åŠ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                params.append('user_sex', userData.user_sex || '');
                params.append('age', userData.age || '');
                params.append('height', userData.height || '');
                params.append('weight', userData.weight || '');
                params.append('season', userData.season || '');
                params.append('body_shape', userData.body_shape || '');
                params.append('style', userData.style.join('ï¼Œ') || '');
                params.append('colors', userData.colors.join('ï¼Œ') || '');
                params.append('username', userData.username || 'æ—¶å°šè¾¾äºº');
                
                // æ„å»ºå®Œæ•´URL
                const chatbotUrl = `http://localhost/chatbot/XeHgGsvjEFBhD3wH?${params.toString()}`;
                
                // è®¾ç½®iframeçš„src
                const iframe = document.getElementById('chatbot-iframe');
                iframe.src = chatbotUrl;
                
                console.log("èŠå¤©URL:", chatbotUrl);
                
            } catch (error) {
                console.error("èŠå¤©æœºå™¨äººåˆå§‹åŒ–å¤±è´¥:", error);
                document.getElementById('dify-chatbot-container').innerHTML = `
                    <div style="padding: 20px; color: red; text-align: center;">
                        <p><strong>èŠå¤©åˆå§‹åŒ–å¤±è´¥</strong></p>
                        <p>${error.message}</p>
                        <button onclick="initDifyChatbot()" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }
        // æ›´æ–°é»˜è®¤å¤´åƒé¢„è§ˆçš„åˆå§‹å€¼ï¼Œä¿æŒä¸€è‡´
        document.addEventListener('DOMContentLoaded', function() {
            const firstAvatarUrl = document.querySelector('.avatar-option').style.backgroundImage;
            document.getElementById('avatar-preview').style.backgroundImage = firstAvatarUrl;
            document.querySelectorAll('.season-option').forEach(season => {
                season.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });
        });
    </script>
</body>
</html>